<!DOCTYPE html>
<html>
  <head>
    <meta name="google-site-verification" content="vPLfvmVSeTNblZy_aIhUxvvqd1CAI52lBSX2BhHMCww" />
    <title>Python Decorators: Not just for decoration – Chris Wong – Student at UC Berkeley</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="Python decorators are syntactic sugar that most people will
run into while working with web frameworks such as Flask or Bottle. 
For example, the following snippet from the Bottle documentation uses
decorators to specify a route:

" />
    <meta property="og:description" content="Python decorators are syntactic sugar that most people will
run into while working with web frameworks such as Flask or Bottle. 
For example, the following snippet from the Bottle documentation uses
decorators to specify a route:

" />
    
    <meta name="author" content="Chris Wong" />

    
    <meta property="og:title" content="Python Decorators: Not just for decoration" />
    <meta property="twitter:title" content="Python Decorators: Not just for decoration" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Chris Wong - Student at UC Berkeley" href="/feed.xml" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://i.imgur.com/FuNGkx1.png" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Chris Wong</a></h1>
            <p class="site-description">Student at UC Berkeley</p>
          </div>

          <nav>
            <a href="/">Home</a>
            <a href="https://drive.google.com/file/d/1XxGLQxflwiz7mFxeYCGHuQDCHGZpQrLQ/view?usp=sharing" target="_blank" rel="noopener noreferrer"> Résumé
            </a>
            <a href="/portfolio">Portfolio</a>
            <a href="/about">About</a>
            <a href="/berkeley-lf-page">Lost+Found</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Python Decorators: Not just for decoration</h1>

  <div class="entry">
    <p>Python decorators are syntactic sugar that most people will
run into while working with web frameworks such as Flask or Bottle. 
For example, the following snippet from the Bottle documentation uses
decorators to specify a route:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@route</span><span class="p">(</span><span class="s">'/hello/&lt;name&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">template</span><span class="p">(</span><span class="s">'&lt;b&gt;Hello &lt;/b&gt;!'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

<span class="c">#Equivalent to index = route('/hello/&lt;name&gt;')(index)</span>
</code></pre></div></div>

<p>In fact the most common use of decorators is to allow framework users 
to hook into some interesting functionality. Of course, there 
are some uses in more common cases. Consider the following decorator:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">memoize</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">memoized</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
            <span class="n">cache</span><span class="p">[</span><span class="n">args</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">args</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">memoized</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">memoize</code> is a higher order function that takes <code class="highlighter-rouge">f</code> (another function) as
input. It creates a dictionary <code class="highlighter-rouge">cache</code>, then returns the function <code class="highlighter-rouge">memoized</code>. Upon closer inspection, <code class="highlighter-rouge">memoized</code> checks whether <code class="highlighter-rouge">cache</code> already contains
its arguments. If not, it computes the value of <code class="highlighter-rouge">cache[args]</code> with <code class="highlighter-rouge">f</code>.</p>

<p>This function is incredibly useful for recursive routines without side-effects.
For example, consider the textbook example of “there’s a time and place for 
recursion, but not now!”:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>This function would normally sport an elegantly inefficient 2^n runtime.
However, applying the memoize decorator would cache the result of each call
to <code class="highlighter-rouge">fib(n)</code> for n in [0..n-1]. This caching procedure reduces the runtime from
exponential to linear (at the cost of memory).</p>

<p><em>A pragmatist would argue to solve the problem iteratively (and a 
hyper-pragmatist would suggest exploiting matrix multiplies), but in such
a case I wouldn’t have an excuse to use decorators.</em></p>

<p>This however, is just the surface of decorators. Back to the framework
examples, I recently put together a <a href="https://github.com/ckw017/showdown.py/">python module for writing Pokemon Showdown chat clients</a> (you can read about why I’ve done so <a href="/Rock-Paper-Scissors/">here</a>). One of the challenges of writing
a module for other’s people use is the necessity for consistent documentation.
Consider the following two function docstrings (apologies in advance for asking you to read documentation):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">private_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="s">"""
    Sends a private message with content to the user specified by user_name.
    The client must be logged in for this to work.

    Params:
        user_name (:obj:`str`) : The name of the user the client will send 
            the message to.
        content (:obj:`str`) : The content of the message.
        strict (:obj:`bool`, optional) : If this flag is set, passing in 
            content more than 300 characters will raise an error. Otherwise,
            the message will be senttruncated with a warning. This paramater
            defaults to False.

    Notes:
        Content should be less than 300 characters long. Longer messages 
        will be concatenated. If the strict flag is set, an error will be 
        raised instead.
    """</span>

<span class="k">def</span> <span class="nf">say</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">room_id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="s">"""
    Sends a chat message to the room specified by room_id. The client must
    be logged in for this to work

    Params:
        room_id (:obj:`str`) : The id of the room the client will send the 
            message to.
        content (:obj:`str`) : The content of the message.
        strict (:obj:`bool`, optional) : If this flag is set, passing in 
            content more than 300 characters will raise an error. Otherwise,
            the message will be sent truncated with a warning. This 
            paramater defaults to False.

    Notes:
        Content should be less than 300 characters long. Longer messages 
        will be concatenated. If the strict flag is set, an error will be
        raised instead.

    """</span>
</code></pre></div></div>

<p>There’s something wrong here. Very, very wrong. Can you spot it? That’s right,
we’re repeating ourselves all over the place! The two functions involved, 
<code class="highlighter-rouge">private_message</code> and <code class="highlighter-rouge">say</code> both do essentially the same thing: send a
message somewhere. As such, their parameters and docstrings bear nearly
identical content, in two different parts of the code base. This violates a
basic rule of programming best practice: <strong>D</strong>on’t <strong>R</strong>epeat <strong>Y</strong>ourself.
The problem lies in trying to update individual parts of the docstring. What
if at some point I chose to concatenate messages at the 350 character limit? I
would have to update the “Notes:” entry of the docstrings in two different
places. This shall not stand.</p>

<p>As you may have guessed from the previous article content, the solution here is
decorators! If you take a look at the source code for <code class="highlighter-rouge">showdown.client</code>, the
actual function declarations look like this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@docutils.format</span><span class="p">()</span>
<span class="n">async</span> <span class="k">def</span> <span class="nf">say</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">room_id</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="s">"""
    Sends a chat message to the room specified by room_id. The client must
    be logged in for this to work

    Params:
        {room_id}
        {content}
        {strict}

    Notes:
        {strict_notes}
    """</span>
</code></pre></div></div>

<p>What’s going on here? I will take this moment to comment on the fact that the 
Python language allows users to do some deep, dark acts of programmatic black
magic. The answer to any question of the form “Hey, can I do {unspeakable act usually involving self-modifying code} in python?” is “Yes, however <code class="highlighter-rouge">PEP 666 + 2/3</code> recommends that you reread Goethe’s <em>Faust</em> before proceeding.” The 
 feature
used here barely qualifies as one of such acts, but might be classified as a
first step towards future acts of Lovecraftian nature.</p>

<p>To be less dramatic, you can modify docstrings (and function signatures for
that matter) programmatically, so that they display differently when calling
<code class="highlighter-rouge">help()</code> in the interpreter. We can use decorators here to do away with
some of the repetition:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#in docutils.py</span>
<span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">full_indent</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">*</span> <span class="s">'    '</span>
    <span class="n">partial_indent</span> <span class="o">=</span> <span class="p">(</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="s">'    '</span>
    <span class="n">docstrings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span><span class="n">v</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">full_indent</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">base_docstrings</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span> <span class="c"># base_docstrings is a dict of prewritten docstrings</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">func</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__doc__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">docstrings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span>
<span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div></div>

<p>There are a few important details in this snippet. First of all, <code class="highlighter-rouge">format</code> is
a function that returns a function, <code class="highlighter-rouge">wrapper</code>, which in turn returns another
function (namely, the modified <code class="highlighter-rouge">func</code>). Functions returning function-valued
functions! Welcome to the world of decorators. The outermost function <code class="highlighter-rouge">format</code> is necessary to deal with quirks of indentation in multiline strings. The
inner function modifies the dunder attribute <code class="highlighter-rouge">__doc__</code> and formats in 
appropriate substitutions for <code class="highlighter-rouge">room_id</code>, <code class="highlighter-rouge">content</code>, etc… as seen in
the previous example. And there we have it! We can modify the part of the
docstring in one place (the entry for <code class="highlighter-rouge">strict_notes</code> in <code class="highlighter-rouge">base_docstrings</code>)
and it will update everywhere it is mentioned in the docstrings.</p>

<p><em>An extra astute reader might observe that we could automate the process
further by automatically reading the parameters from the function signature
and dynamically generating the “Params:” section of the docstring. While I
considered this, there were various cases within the project where paramater 
name collisions would complicate things, so I chose to forgo it.</em></p>

<p>Whether you’re writing a framework or using one, decorators are definitely a
handy tool to have in your metaphorical toolbox!</p>

  </div>

  <div class="date">
    Written on January 14, 2019
  </div>

  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          



<a href="https://github.com/ckw017"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/chriswong21"><i class="svg-icon linkedin"></i></a>





<br>
        </footer>
      </div>
    </div>

    

  </body>
</html>
